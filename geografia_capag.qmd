---
title: "Mapas da CAPAG"
author: "Fernando Barbalho"
format: pptx
editor: visual
execute:
  cache: true
---

```{r}
library(tidyverse)
library(colorspace)
library(patchwork)
library(reshape2)
library(sf)


mapa_municipios<- rio::import("mapa_municipios.RDS")
sedes_municipios<- rio::import("sedes_municipios.RDS")
estados<- rio::import("estados.RDS")
brasil<- rio::import("brasil.RDS")
ibge2022<- rio::import("ibge2022.RDS")
dados_capag_2022 <- rio::import("dados_capag_2022.RDS")

```

## Distribuição das notas

```{r}
dados_capag_2022 %>%
  ggplot() +
  geom_bar(aes(y=sort(capag_oficial, decreasing = TRUE))) +
  theme_light() +
  theme(
    #text = element_text(size=20),
    panel.background = element_rect(fill = "black"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.key = element_rect(fill = "black")
    
  )
  
```

## Distribuição nos estados - ranking total

```{r}
dados_capag_2022 %>%
  summarise(.by = c("uf","capag_oficial"),
            quantidade = n()) %>%
  mutate(uf = reorder(uf, quantidade)) %>%
  ggplot() +
  geom_col(aes(y=uf, x= quantidade, fill= capag_oficial)) +
  scale_fill_discrete_qualitative("Dark 3")+
  theme_light() +
  theme(
    panel.background = element_rect(fill = "black"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.key = element_rect(fill = "black")
    
  )
```

## Distribuição nos estados - proporção notas

```{r}
dados_capag_2022 %>%
  summarise(.by = c("uf","capag_oficial"),
            quantidade = n()) %>%
  mutate(uf = reorder(uf, quantidade)) %>%
  ggplot() +
  geom_col(aes(y=uf, x= quantidade, fill= capag_oficial),position = "fill") +
  scale_fill_discrete_qualitative("Dark 3")+
  theme_light() +
  theme(
    panel.background = element_rect(fill = "black"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.key = element_rect(fill = "black")
    
  )
```

## Distribuição anormal nos estados

```{r}


### Testes de chi quadrado

teste_chi<-
chisq.test(dados_capag_2022$uf, dados_capag_2022$capag_oficial, simulate.p.value = TRUE)

residuo_teste<-
as_tibble(teste_chi[["stdres"]])

names(residuo_teste) <- c("uf","capag_oficial","n")

residuo_teste %>%
  filter(n<=-2 | n>=2) %>%   
  mutate(rank = rank(-abs(n))) %>%
  mutate(ordem = as.factor(rank)) %>%
  mutate(ordem = fct_reorder(ordem, rank, .desc=TRUE) ) %>%
  ggplot(aes(x=n,y=ordem, fill= capag_oficial), color = "black")+
  geom_col() +
  geom_vline(xintercept = c(-2,2), color = "white") +
  scale_fill_discrete_qualitative("Dark 3")+
  theme_light() +
  theme(
    #text = element_text(size=20),
    panel.background = element_rect(fill = "black"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    legend.key = element_rect(fill = "black")
    
  ) +
  labs(title = "Resíduos relevantes",
       fill = "Nota CAPAG")


```

## Distribuição anormal nos estados - Diferenças

```{r}

# Read the data
data <- read.csv('resultado_chi_quadrado.csv')

# Calculate the difference between observed and expected values
expected <- subset(data, tipo == 'Esperado')
observed <- subset(data, tipo != 'Esperado')

# Merge observed and expected datasets by 'uf' and 'capag_oficial'
merged_data <- merge(expected, observed, by = c("uf", "capag_oficial"))

# Calculate the difference
merged_data$difference <- merged_data$n.y - merged_data$n.x

# Plot the heatmap using ggplot2
ggplot(merged_data, aes(x = capag_oficial, y = uf, fill = difference)) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0) +
  geom_text(aes(label = sprintf("%.2f", difference)), size = 3) +
  labs(title = "Diferença entre n observado e esperado",
       x = "Categoria CAPAG",
       y = "Estado",
       fill = "Diferença") +
  theme_light()

```

## Distribuição anormal nos estados - CAPAG A

```{r}
residuo_teste %>%
  filter(capag_oficial == "A") %>%
  filter(n<=-2 | n>=2) %>%   
  mutate(rank = rank(-abs(n))) %>%
  mutate(ordem = as.factor(rank)) %>%
  mutate(ordem = fct_reorder(ordem, rank, .desc=TRUE) ) %>%
  ggplot(aes(x=n,y=ordem), color = "black")+
  geom_col() +
  geom_text(aes(label= uf), color = "white") +
  geom_vline(xintercept = c(-2,2), color = "white") +
  scale_fill_discrete_qualitative("Pastel 1")+
  theme_light() +
  theme(
    #text = element_text(size=20),
    panel.background = element_rect(fill = "black"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    legend.key = element_rect(fill = "black")
    
  ) +
  labs(title = "Resíduos relevantes - Nota CAPAG A")

```

## Mapa distribuição anormal nos estados - CAPAG A

```{r}

#Busca ufs relevantes para nota A com desvio padrão positivo

ufs_a<- 
(residuo_teste %>%
  filter(capag_oficial == "A") %>%
  filter(n>=2))$uf 


# Read the data
data <- read.csv('resultado_chi_quadrado.csv')

#monta dataframe com municipíos esperados

df_sample_esperado<-
purrr::map_dfr(ufs_a, function(a_uf){
  quantidade<-
    (data %>%
    filter(tipo=="Esperado",
           capag_oficial == "A",
           uf == a_uf))$n
  
  quantidade<- round(quantidade)
  
  
  dados_capag_2022 %>%
    filter(capag_oficial == "A",
           uf == a_uf) %>%
    slice_sample(n= quantidade)

})



m1<-
sedes_municipios %>%
  inner_join(
    df_sample_esperado %>%
      rename(code_muni = cod_ibge)
  ) %>%
  ggplot()+
  geom_sf( pch=21, fill="#ff6600",  color="#ff6600", size= 0.5) +
  #geom_sf(data = sedes,pch=21,  fill=point_color, color = point_color, size= 0.5 )+
  geom_sf(data= estados, fill=NA, color="white") +
  theme_light() +
  theme(
    panel.background = element_rect(fill = "black"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.background = element_rect(fill = "#505050"),
    strip.text = element_text(color = "white"),
    axis.text = element_blank(),
    legend.key = element_rect(fill = "black")

  )


m2<-
sedes_municipios %>%
  inner_join(
      dados_capag_2022 %>%
    filter(capag_oficial == "A",
           uf %in% ufs_a) %>%
      rename(code_muni = cod_ibge)
  ) %>%
  ggplot()+
  geom_sf( pch=21, fill="#ff6600",  color="#ff6600", size= 0.5) +
  #geom_sf(data = sedes,pch=21,  fill=point_color, color = point_color, size= 0.5 )+
  geom_sf(data= estados, fill=NA, color="white") +
  theme_light() +
  theme(
    #text = element_text(size=20),
    panel.background = element_rect(fill = "black"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.background = element_rect(fill = "#505050"),
    strip.text = element_text(color = "white"),
    axis.text = element_blank(),
    legend.key = element_rect(fill = "black")

  )
# 
# 
m1+m2


```

## Mapa distribuição anormal nos estados - CAPAG A

```{r}
m1<-
sedes_municipios %>%
  inner_join(
    df_sample_esperado %>%
      filter(uf=="RS") %>%
      rename(code_muni = cod_ibge)
  ) %>%
  ggplot()+
  geom_sf( pch=21, fill="#ff6600",  color="#ff6600", size= 0.5) +
  #geom_sf(data = sedes,pch=21,  fill=point_color, color = point_color, size= 0.5 )+
  geom_sf(data= estados[estados$abbrev_state=="RS",], fill=NA, color="white") +
  theme_light() +
  theme(
    panel.background = element_rect(fill = "black"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.background = element_rect(fill = "#505050"),
    strip.text = element_text(color = "white"),
    axis.text = element_blank(),
    legend.key = element_rect(fill = "black")

  )


m2<-
sedes_municipios %>%
  inner_join(
      dados_capag_2022 %>%
    filter(capag_oficial == "A",
           uf == "RS") %>%
      rename(code_muni = cod_ibge)
  ) %>%
  ggplot()+
  geom_sf( pch=21, fill="#ff6600",  color="#ff6600", size= 0.5) +
  #geom_sf(data = sedes,pch=21,  fill=point_color, color = point_color, size= 0.5 )+
  geom_sf(data= estados[estados$abbrev_state=="RS",], fill=NA, color="white") +
  theme_light() +
  theme(
    #text = element_text(size=20),
    panel.background = element_rect(fill = "black"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.background = element_rect(fill = "#505050"),
    strip.text = element_text(color = "white"),
    axis.text = element_blank(),
    legend.key = element_rect(fill = "black")

  )
# 
# 
m1+m2

```

## Mapa distribuição anormal nos estados - CAPAG A

```{r}
#Busca ufs relevantes para nota A com desvio padrão negativo

ufs_a<- 
(residuo_teste %>%
  filter(capag_oficial == "A") %>%
  filter(n<=-2))$uf 


# Read the data
data <- read.csv('resultado_chi_quadrado.csv')

#monta dataframe com municipíos esperados

df_sample_esperado<-
purrr::map_dfr(ufs_a, function(a_uf){
  quantidade<-
    (data %>%
    filter(tipo=="Esperado",
           capag_oficial == "A",
           uf == a_uf))$n
  
  quantidade<- round(quantidade)
  
  
  sedes_municipios %>%
    filter(abbrev_state == a_uf) %>%
    slice_sample(n= quantidade)

})



m1<-
df_sample_esperado%>%
  ggplot()+
  geom_sf( pch=21, fill="#ff6600",  color="#ff6600", size= 0.5) +
  #geom_sf(data = sedes,pch=21,  fill=point_color, color = point_color, size= 0.5 )+
  geom_sf(data= estados, fill=NA, color="white") +
  theme_light() +
  theme(
    panel.background = element_rect(fill = "black"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.background = element_rect(fill = "#505050"),
    strip.text = element_text(color = "white"),
    axis.text = element_blank(),
    legend.key = element_rect(fill = "black")

  )


m2<-
sedes_municipios %>%
  inner_join(
      dados_capag_2022 %>%
    filter(capag_oficial == "A",
           uf %in% ufs_a) %>%
      rename(code_muni = cod_ibge)
  ) %>%
  ggplot()+
  geom_sf( pch=21, fill="#ff6600",  color="#ff6600", size= 0.5) +
  #geom_sf(data = sedes,pch=21,  fill=point_color, color = point_color, size= 0.5 )+
  geom_sf(data= estados, fill=NA, color="white") +
  theme_light() +
  theme(
    #text = element_text(size=20),
    panel.background = element_rect(fill = "black"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    strip.background = element_rect(fill = "#505050"),
    strip.text = element_text(color = "white"),
    axis.text = element_blank(),
    legend.key = element_rect(fill = "black")

  )
# 
# 
m1+m2

```

## Mapa distribuição anormal nos estados - CAPAG A



## Distribuição nos estados - CAPAG B

```{r}
residuo_teste %>%
  filter(capag_oficial == "B") %>%
  filter(n<=-2 | n>=2) %>%   
  mutate(rank = rank(-abs(n))) %>%
  mutate(ordem = as.factor(rank)) %>%
  mutate(ordem = fct_reorder(ordem, rank, .desc=TRUE) ) %>%
  ggplot(aes(x=n,y=ordem), color = "black")+
  geom_col() +
  geom_text(aes(label= uf), color = "white") +
  geom_vline(xintercept = c(-2,2), color = "white") +
  scale_fill_discrete_qualitative("Pastel 1")+
  theme_light() +
  theme(
    #text = element_text(size=20),
    panel.background = element_rect(fill = "black"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    legend.key = element_rect(fill = "black")
    
  ) +
  labs(title = "Resíduos relevantes - Nota CAPAG B")

```

## Distribuição nos estados - CAPAG C

```{r}
residuo_teste %>%
  filter(capag_oficial == "C") %>%
  filter(n<=-2 | n>=2) %>%   
  mutate(rank = rank(-abs(n))) %>%
  mutate(ordem = as.factor(rank)) %>%
  mutate(ordem = fct_reorder(ordem, rank, .desc=TRUE) ) %>%
  ggplot(aes(x=n,y=ordem), color = "black")+
  geom_col() +
  geom_text(aes(label= uf), color = "white") +
  geom_vline(xintercept = c(-2,2), color = "white") +
  scale_fill_discrete_qualitative("Pastel 1")+
  theme_light() +
  theme(
    #text = element_text(size=20),
    panel.background = element_rect(fill = "black"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    legend.key = element_rect(fill = "black")
    
  ) +
  labs(title = "Resíduos relevantes - Nota CAPAG C")
```

## Distribuição nos estados - CAPAG D

```{r}
residuo_teste %>%
  filter(capag_oficial == "D") %>%
  filter(n<=-2 | n>=2) %>%   
  mutate(rank = rank(-abs(n))) %>%
  mutate(ordem = as.factor(rank)) %>%
  mutate(ordem = fct_reorder(ordem, rank, .desc=TRUE) ) %>%
  ggplot(aes(x=n,y=ordem), color = "black")+
  geom_col() +
  geom_text(aes(label= uf), color = "white") +
  geom_vline(xintercept = c(-2,2), color = "white") +
  scale_fill_discrete_qualitative("Pastel 1")+
  theme_light() +
  theme(
    #text = element_text(size=20),
    panel.background = element_rect(fill = "black"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    legend.key = element_rect(fill = "black")
    
  ) +
  labs(title = "Resíduos relevantes - Nota CAPAG D")
```

## Distribuição nos estados - CAPAG não determinada

```{r}
residuo_teste %>%
  filter(capag_oficial == "n.d.") %>%
  filter(n<=-2 | n>=2) %>%   
  mutate(rank = rank(-abs(n))) %>%
  mutate(ordem = as.factor(rank)) %>%
  mutate(ordem = fct_reorder(ordem, rank, .desc=TRUE) ) %>%
  ggplot(aes(x=n,y=ordem), color = "black")+
  geom_col() +
  geom_text(aes(label= uf), color = "white") +
  geom_vline(xintercept = c(-2,2), color = "white") +
  scale_fill_discrete_qualitative("Pastel 1")+
  theme_light() +
  theme(
    #text = element_text(size=20),
    panel.background = element_rect(fill = "black"),
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    legend.key = element_rect(fill = "black")
    
  ) +
  labs(title = "Resíduos relevantes - Nota CAPAG não determinada")
```

## Distribuição por hierarquia de Regiões de influência

When you click the **Render** button a document will be generated that includes:

-   Content authored with markdown
-   Output from executable code

## Distribuição por clusters espaciais

When you click the **Render** button a presentation will be generated that includes both content and the output of embedded code. You can embed code like this:

## Riscos e população

When you click the **Render** button a presentation will be generated that includes both content and the output of embedded code. You can embed code like this:
